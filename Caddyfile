{
	servers {
		metrics
	}

	frankenphp {
		num_threads 4
	}
}

{$DOMAIN:localhost} {
	encode gzip
	root * public

	log {
		output file /var/log/caddy/access.log {
			roll_size 100MB
			roll_keep 5
			roll_keep_for 720h
		}
		format json
		level INFO
	}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "geolocation=()"
		-Server
	}

	route {
		@cors_preflight {
			path /api/*
			method OPTIONS
		}
		handle @cors_preflight {
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
			header Access-Control-Max-Age "86400"
			respond "" 204
		}

		@static {
			path *.css *.js *.ico *.png *.jpg *.jpeg *.gif *.svg *.woff *.woff2 *.ttf *.eot *.mp4 *.webm *.mp3 *.wav
		}
		handle @static {
			header Cache-Control "public, max-age=31536000, immutable"
			file_server
		}

		handle /vendor/* {
			header Cache-Control "public, max-age=2592000"
			file_server
		}

		handle /build/* {
			header Cache-Control "public, max-age=31536000, immutable"
			file_server
		}

		@websocket {
			header Connection *Upgrade*
			header Upgrade websocket
		}
		handle @websocket {
			reverse_proxy localhost:6001
		}

		@api path /api/*
		header @api -Cache-Control
		header @api -Expires
		header @api Cache-Control "no-store, no-cache, must-revalidate"
		header @api Access-Control-Allow-Origin "*"
		header @api Access-Control-Allow-Credentials "true"

		php_server
	}

	handle_errors {
		@5xx expression {http.error.status_code} >= 500
		handle @5xx {
			respond "Internal Server Error" 500
		}
		
		@4xx expression {http.error.status_code} >= 400
		handle @4xx {
			respond "Not Found" 404
		}
	}
}

health.{$DOMAIN:localhost} {
	respond /health "OK" 200
	
	handle /metrics {
		metrics
	}
}

www.{$DOMAIN} {
	redir https://{$DOMAIN}{uri} permanent
}
